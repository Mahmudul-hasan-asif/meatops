<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeatOps Admin - Inventory</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .hidden{display:none!important}
    .inline{display:inline-flex;gap:.5rem;align-items:center}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .select{min-width:140px}
    .table .actions-inline{display:flex;gap:.5rem;flex-wrap:wrap}
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-icon">ðŸ¥©</div>
      <div>
        <h1>MeatOps</h1>
        <small>Admin Console</small>
      </div>
    </div>
    <nav class="nav">
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="intake.html" class="nav-link">Livestock / Intake</a>
      <a href="processing.html" class="nav-link">Processing &amp; Yield</a>
      <a href="inventory.html" class="nav-link">Inventory</a>
      <a href="storage.html" class="nav-link">Storage &amp; IoT</a>
      <a href="quality.html" class="nav-link">Quality Control</a>
      <a href="waste-management.html" class="nav-link">Waste Management</a>
      <a href="orders.html" class="nav-link">Orders &amp; Distribution</a>
      <a href="analytics.html" class="nav-link">Forecasting &amp; Analytics</a>
      <a href="compliance.html" class="nav-link">Compliance &amp; Recall</a>
      <a href="suppliers.html" class="nav-link">Suppliers</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </nav>
    <footer class="sidebar-footer">v2.2</footer>
  </aside>

  <main class="main">
    <!-- HEADER -->
    <header class="topbar">
      <div class="breadcrumbs"><span>Inventory</span></div>
    </header>

    <!-- INVENTORY -->
    <section class="page show" id="inventory">
      <div class="stack inv-split">
        <!-- Products -->
        <div class="card split">
          <div class="card-head">
            <h2>Products</h2>
            <div class="toolbar">
              <input type="text" id="search-name" placeholder="Search by name" />
              <input type="number" id="search-id" placeholder="ID" />
              <button class="btn outline" id="btn-search">Search</button>
              <button class="btn" id="btn-reset">Reset</button>
              <button class="btn primary open-modal" data-modal="modal-product-create">+ Add Product</button>
            </div>
          </div>

          <div class="table-scroll">
            <table class="table" id="tbl-products">
              <thead>
                <tr>
                  <th>Product ID</th>
                  <th>Animal</th>
                  <th>Product name</th>
                  <th>Price</th>
                  <th>Discounted</th>
                  <th>Quantity (kg)</th>
                  <th>Sale</th>
                  <th>Sale end</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- (Optional) Batches by Facility â€” unchanged -->
        <div class="card split">
          <div class="card-head">
            <h2>Batches by Facility</h2>
            <button class="btn open-modal" data-modal="modal-bf-create">+ Add Lot to Facility</button>
          </div>
          <div class="table-scroll">
            <table class="table" id="tbl-inventory-batches">
              <thead>
                <tr>
                  <th>Lot/Batch</th>
                  <th>Product</th>
                  <th>Facility + Bin</th>
                  <th>Qty (Avail/Total)</th>
                  <th>Expiry</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="footer">Â© 2025 MeatOps â€¢ All actions are auditable.</footer>
  </main>

  <!-- ===== MODALS: PRODUCTS ===== -->
  <div class="modal" id="modal-product-create" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head"><h3>Add Product</h3><button class="icon close-modal">âœ•</button></div>
      <form class="form" id="form-product-create">
        <div class="two">
          <label>Product name <input name="product_name" required></label>
          <label>Animal type
            <select name="animal_type" class="select" required>
              <option value="cow">Cow</option>
              <option value="chicken">Chicken</option>
              <option value="mutton">Mutton</option>
              <option value="duck">Duck</option>
            </select>
          </label>
        </div>
        <div class="two">
          <label>Price <input name="price" type="number" step="0.01" required></label>
          <label>Quantity
            <select name="quantity" class="select" required>
              <option value="1">1 kg</option>
              <option value="5">5 kg</option>
              <option value="10">10 kg</option>
            </select>
          </label>
        </div>
        <div class="two">
          <label>Sale
            <select name="sale" id="create-sale" class="select">
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </label>
          <label>Sale end date
            <input name="sale_end_date" id="create-sale-end" type="date" disabled>
          </label>
        </div>
        <div id="create-sale-extra" class="two hidden">
          <label>Discount % <input name="sale_discount_percent" id="create-sale-discount" type="number" step="0.01" min="0" max="100"></label>
          <div></div>
        </div>
        <div class="modal-actions">
          <button class="btn" type="button" data-cancel>Cancel</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="modal-product-edit" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head"><h3>Edit Product</h3><button class="icon close-modal">âœ•</button></div>
      <form class="form" id="form-product-edit">
        <input type="hidden" name="product_id" />
        <div class="two">
          <label>Product name <input name="product_name" required></label>
          <label>Animal type
            <select name="animal_type" class="select" required>
              <option value="cow">Cow</option>
              <option value="chicken">Chicken</option>
              <option value="mutton">Mutton</option>
              <option value="duck">Duck</option>
            </select>
          </label>
        </div>
        <div class="two">
          <label>Price <input name="price" type="number" step="0.01" required></label>
          <label>Quantity
            <select name="quantity" class="select" required>
              <option value="1">1 kg</option>
              <option value="5">5 kg</option>
              <option value="10">10 kg</option>
            </select>
          </label>
        </div>
        <div class="two">
          <label>Sale
            <select name="sale" id="edit-sale" class="select">
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </label>
          <label>Sale end date
            <input name="sale_end_date" id="edit-sale-end" type="date" disabled>
          </label>
        </div>
        <div id="edit-sale-extra" class="two hidden">
          <label>Discount % <input name="sale_discount_percent" id="edit-sale-discount" type="number" step="0.01" min="0" max="100"></label>
          <div></div>
        </div>
        <div class="modal-actions">
          <button class="btn" type="button" data-cancel>Cancel</button>
          <button class="btn primary" type="submit">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== MODALS: BATCHES BY FACILITY (unchanged placeholders) ===== -->
  <div class="modal" id="modal-bf-create" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head"><h3>Add Lot to Facility</h3><button class="icon close-modal">âœ•</button></div>
      <form class="form" id="form-bf-create">
        <div class="two">
          <label>Batch ID <input name="batch_id" type="number" required></label>
          <label>Product ID <input name="product_id" type="number" required></label>
        </div>
        <div class="two">
          <label>Facility ID <input name="facility_id" type="number" required></label>
          <label>Bin/Location <input name="location_bin" placeholder="A-03-R2-B15"></label>
        </div>
        <div class="two">
          <label>On Hand (kg) <input name="qty_on_hand_kg" type="number" step="0.01" required></label>
          <label>Reserved (kg) <input name="qty_reserved_kg" type="number" step="0.01" value="0"></label>
        </div>
        <div class="two">
          <label>Expiry Date <input name="expiry_date" type="date" required></label>
          <label>Status
            <select name="status">
              <option value="available">available</option>
              <option value="allocated">allocated</option>
              <option value="on_hold">on_hold</option>
              <option value="expired">expired</option>
            </select>
          </label>
        </div>
        <label>Lot Code <input name="lot_code" placeholder="optional (auto if blank)"></label>
        <div class="modal-actions">
          <button class="btn" type="button" data-cancel>Cancel</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="modal-bf-edit" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head"><h3>Edit Lot in Facility</h3><button class="icon close-modal">âœ•</button></div>
      <form class="form" id="form-bf-edit">
        <input type="hidden" name="id" />
        <div class="two">
          <label>Facility ID <input name="facility_id" type="number" required></label>
          <label>Bin/Location <input name="location_bin"></label>
        </div>
        <div class="two">
          <label>On Hand (kg) <input name="qty_on_hand_kg" type="number" step="0.01" required></label>
          <label>Reserved (kg) <input name="qty_reserved_kg" type="number" step="0.01" required></label>
        </div>
        <div class="two">
          <label>Expiry Date <input name="expiry_date" type="date" required></label>
          <label>Status
            <select name="status">
              <option value="available">available</option>
              <option value="allocated">allocated</option>
              <option value="on_hold">on_hold</option>
              <option value="expired">expired</option>
            </select>
          </label>
        </div>
        <label>Lot Code <input name="lot_code"></label>
        <div class="modal-actions">
          <button class="btn" type="button" data-cancel>Cancel</button>
          <button class="btn primary" type="submit">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="modal-bf-move" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head"><h3>Move / Split Lot</h3><button class="icon close-modal">âœ•</button></div>
      <form class="form" id="form-bf-move">
        <input type="hidden" name="source_id" />
        <div class="two">
          <label>Qty to move (kg) <input name="qty" type="number" step="0.01" required></label>
          <label>Target Facility ID <input name="target_facility_id" type="number" required></label>
        </div>
        <label>Target Bin/Location <input name="target_location_bin" placeholder="A-03-R2-B15"></label>
        <div class="modal-actions">
          <button class="btn" type="button" data-cancel>Cancel</button>
          <button class="btn primary" type="submit">Move / Split</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ---------- Modal helpers ---------- */
    document.querySelectorAll('.modal').forEach(m=>m.setAttribute('aria-hidden','true'));
    function openModal(id){ const m=document.getElementById(id); if(m){ m.setAttribute('aria-hidden','false'); document.body.classList.add('body-modal-open'); } }
    function closeModal(el){ const m=el.closest?.('.modal') || (typeof el==='string' ? document.getElementById(el) : null); if(!m) return; m.setAttribute('aria-hidden','true'); if(![...document.querySelectorAll('.modal')].some(x=>x.getAttribute('aria-hidden')==='false')) document.body.classList.remove('body-modal-open'); }
    document.addEventListener('click', e=>{ if(e.target.matches('.open-modal')) openModal(e.target.dataset.modal); if(e.target.matches('.close-modal,[data-cancel]')) closeModal(e.target); if(e.target.classList.contains('modal')) closeModal(e.target); });

    /* ---------- Products CRUD + Search ---------- */
    const productsTbody = document.querySelector('#tbl-products tbody');
    const createForm = document.querySelector('#form-product-create');
    const editForm = document.querySelector('#form-product-edit');

    const inpSearchName  = document.getElementById('search-name');
    const inpSearchId    = document.getElementById('search-id');
    const btnSearch = document.getElementById('btn-search');
    const btnReset  = document.getElementById('btn-reset');

    const createSaleSel = document.getElementById('create-sale');
    const createSaleExtra = document.getElementById('create-sale-extra');
    const createSaleEnd = document.getElementById('create-sale-end');
    const createSaleDiscount = document.getElementById('create-sale-discount');

    const editSaleSel = document.getElementById('edit-sale');
    const editSaleExtra = document.getElementById('edit-sale-extra');
    const editSaleEnd = document.getElementById('edit-sale-end');
    const editSaleDiscount = document.getElementById('edit-sale-discount');

    function toggleSaleExtra(sel, box, endInput, discInput){
      const yes = String(sel.value) === '1';
      box.classList.toggle('hidden', !yes);
      endInput.disabled = !yes;
      if(yes){
        discInput.setAttribute('required','required');
        endInput.setAttribute('required','required');
      } else {
        discInput.removeAttribute('required');
        endInput.removeAttribute('required');
        discInput.value = '';
        endInput.value = '';
      }
    }
    createSaleSel.addEventListener('change', ()=>toggleSaleExtra(createSaleSel, createSaleExtra, createSaleEnd, createSaleDiscount));
    editSaleSel.addEventListener('change', ()=>toggleSaleExtra(editSaleSel, editSaleExtra, editSaleEnd, editSaleDiscount));

    let PRODUCTS_CACHE = [];

    function money(v){ const n=Number(v||0); return isFinite(n)? n.toFixed(2):'0.00'; }
    function niceAnimal(a){ return (a||'').charAt(0).toUpperCase()+ (a||'').slice(1); }
    function discounted(price, sale, pct){
      if(String(sale)!=='1') return null;
      const p = Number(price), d = Number(pct);
      if(!isFinite(p) || !isFinite(d)) return null;
      return (p * (1 - d/100)).toFixed(2);
    }

    function rowHTML(p){
      const disc = discounted(p.price, p.sale, p.sale_discount_percent);
      return `
        <tr data-id="${p.product_id}">
          <td>${p.product_id}</td>
          <td>${niceAnimal(p.animal_type)}</td>
          <td>${p.product_name ?? ''}</td>
          <td>${money(p.price)}</td>
          <td>${disc !== null ? disc : 'â€”'}</td>
          <td>${p.quantity} kg</td>
          <td>${p.sale==1 ? 'Yes':'No'}</td>
          <td>${p.sale_end_date ?? ''}</td>
          <td>
            <div class="actions-inline">
              <button class="btn sm outline act-edit">Edit</button>
              <button class="btn sm danger act-delete">Delete</button>
            </div>
          </td>
        </tr>`;
    }

    function renderProducts(arr){
      if(!arr || !arr.length){
        productsTbody.innerHTML = '<tr><td colspan="9">No products found.</td></tr>';
        return;
      }
      productsTbody.innerHTML = arr.map(rowHTML).join('');
    }

    async function loadProducts(){
      productsTbody.innerHTML = '<tr><td colspan="9">Loadingâ€¦</td></tr>';
      try{
        // NOTE: endpoints should use DB table `product` (not `products`)
        const res = await fetch('api/products-list.php');
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || 'Load error');
        PRODUCTS_CACHE = Array.isArray(json.data) ? json.data : [];
        renderProducts(PRODUCTS_CACHE);
      }catch(err){
        productsTbody.innerHTML = '<tr><td colspan="9">Failed to load.</td></tr>';
        console.error(err);
      }
    }

    function applyProductSearch(){
      let list = PRODUCTS_CACHE.slice();
      const name  = (inpSearchName.value || '').trim().toLowerCase();
      const idStr = (inpSearchId.value || '').trim();

      if(idStr !== ''){
        const id = parseInt(idStr, 10);
        if(!isNaN(id)) list = list.filter(p => p.product_id === id);
        return renderProducts(list);
      }

      if(name) list = list.filter(p => (p.product_name || '').toLowerCase().includes(name));
      renderProducts(list);
    }

    btnSearch.addEventListener('click', applyProductSearch);
    btnReset.addEventListener('click', ()=>{
      inpSearchName.value = '';
      inpSearchId.value = '';
      renderProducts(PRODUCTS_CACHE);
    });
    [inpSearchName, inpSearchId].forEach(el=>{
      el.addEventListener('keydown', e=>{
        if(e.key === 'Enter'){ e.preventDefault(); applyProductSearch(); }
      });
    });

    createForm.addEventListener('submit', async e=>{
      e.preventDefault();
      toggleSaleExtra(createSaleSel, createSaleExtra, createSaleEnd, createSaleDiscount);
      const data = Object.fromEntries(new FormData(createForm).entries());
      try{
        const res = await fetch('api/product-create.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || 'Create failed');
        PRODUCTS_CACHE.unshift(json.data);
        renderProducts(PRODUCTS_CACHE);
        closeModal(createForm);
        createForm.reset();
        createSaleSel.value='0'; toggleSaleExtra(createSaleSel, createSaleExtra, createSaleEnd, createSaleDiscount);
      }catch(err){ alert(err.message); }
    });

    productsTbody.addEventListener('click', async e=>{
      const row = e.target.closest('tr'); if(!row) return;
      const id = row.dataset.id;

      if(e.target.closest('.act-edit')){
        const item = PRODUCTS_CACHE.find(p => String(p.product_id)===String(id));
        if(!item) return;
        editForm.product_id.value   = id;
        editForm.product_name.value = item.product_name || '';
        editForm.animal_type.value  = (item.animal_type || 'cow').toLowerCase();
        editForm.price.value        = item.price || 0;
        editForm.quantity.value     = String(item.quantity||1);
        editForm.sale.value         = String(item.sale||0);
        editForm.sale_end_date.value= item.sale_end_date || '';
        editForm.sale_discount_percent.value = item.sale_discount_percent != null ? item.sale_discount_percent : '';
        toggleSaleExtra(editSaleSel, editSaleExtra, editSaleEnd, editSaleDiscount);
        openModal('modal-product-edit');
      }

      if(e.target.closest('.act-delete')){
        if(!confirm('Delete this product?')) return;
        try{
          const res = await fetch('api/product-delete.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product_id:id})});
          const json = await res.json();
          if(!json.ok) throw new Error(json.error || 'Delete failed');
          PRODUCTS_CACHE = PRODUCTS_CACHE.filter(p => String(p.product_id) !== String(id));
          renderProducts(PRODUCTS_CACHE);
        }catch(err){ alert(err.message); }
      }
    });

    editForm.addEventListener('submit', async e=>{
      e.preventDefault();
      toggleSaleExtra(editSaleSel, editSaleExtra, editSaleEnd, editSaleDiscount);
      const data = Object.fromEntries(new FormData(editForm).entries());
      try{
        const res = await fetch('api/product-update.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || 'Update failed');
        const idx = PRODUCTS_CACHE.findIndex(p => String(p.product_id) === String(data.product_id));
        if(idx > -1) PRODUCTS_CACHE[idx] = json.data;
        renderProducts(PRODUCTS_CACHE);
        closeModal(editForm);
        editForm.reset();
      }catch(err){ alert(err.message); }
    });

    /* ---------- Batches by Facility (unchanged demo wiring) ---------- */
    const bfTbody = document.querySelector('#tbl-inventory-batches tbody');
    async function loadBF(){
      try{
        const res = await fetch('api/bf-list.php');
        const json = await res.json();
        if(!json.ok || !json.data?.length){ bfTbody.innerHTML = '<tr><td colspan="7">No lots.</td></tr>'; return; }
        bfTbody.innerHTML = json.data.map(r=>{
          const onHand   = Number(r.qty_on_hand_kg || 0);
          const reserved = Number(r.qty_reserved_kg || 0);
          const avail    = onHand;
          const total    = onHand + reserved;
          const lot = r.lot_code && r.lot_code.trim()!=='' ? r.lot_code : `B#${r.batch_id}`;
          const facBin = `<div class="facility">${r.facility_name||''}</div><div class="bin">${r.location_bin||'-'}</div>`;
          const today = new Date(); today.setHours(0,0,0,0);
          const d = r.expiry_date ? new Date(r.expiry_date+"T00:00:00") : null;
          const dleft = d ? Math.ceil((d - today)/(1000*60*60*24)) : null;
          const cls = dleft==null ? 'badge' : (dleft<0?'badge danger':(dleft<=3?'badge warn':'badge ok'));
          const txt = dleft==null ? '' : (dleft<0?`${Math.abs(dleft)} days ago`:`in ${dleft} days`);
          const expiry = `<span class="${cls}">${r.expiry_date||''}${txt?` â€¢ ${txt}`:''}</span>`;
          const stMap = {available:'pill ok', allocated:'pill info', on_hold:'pill warn', expired:'pill danger'};
          return `
          <tr data-id="${r.bf_id}">
            <td>${lot}</td>
            <td>${r.product_name||''}</td>
            <td>${facBin}</td>
            <td>${avail.toFixed(2)} / ${total.toFixed(2)} kg</td>
            <td>${expiry}</td>
            <td><span class="${stMap[r.status]||'pill'}">${r.status}</span></td>
            <td>
              <div class="actions-inline">
                <button class="btn sm danger act-bf-delete">Delete</button>
                <button class="btn sm outline act-bf-edit">Edit</button>
                <button class="btn sm outline act-bf-split">Split</button>
              </div>
            </td>
          </tr>`;
        }).join('');
      }catch(e){
        bfTbody.innerHTML = '<tr><td colspan="7">Failed to load.</td></tr>';
      }
    }
    // For brevity, BF modals submit handlers omitted (same as your working version)

    // Init
    loadProducts();
    loadBF();

    // highlight nav
    (function () {
      const here = (location.pathname.split('/').pop() || 'inventory.html').toLowerCase();
      document.querySelectorAll('aside .nav a.nav-link').forEach(a => {
        const href = a.getAttribute('href') || '';
        const target = href.split('/').pop().split('#')[0].toLowerCase();
        if (here === target) a.classList.add('active');
      });
    }());
  </script>
</body>
</html>
