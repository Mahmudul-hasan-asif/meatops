<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeatOps Admin - Processing & Yield</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- SIDEBAR / NAVBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-icon">ðŸ¥©</div>
      <div>
        <h1>MeatOps</h1>
        <small>Admin Console</small>
      </div>
    </div>

    <nav class="nav">
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="intake.html" class="nav-link">Livestock / Intake</a>
      <a href="processing.html" class="nav-link">Processing &amp; Yield</a>
      <a href="inventory.html" class="nav-link">Inventory</a>
      <a href="storage.html" class="nav-link">Storage &amp; IoT</a>
      <a href="quality.html" class="nav-link">Quality Control</a>
      <a href="waste-management.html" class="nav-link">Waste Management</a>
      <a href="orders.html" class="nav-link">Orders &amp; Distribution</a>
      <a href="analytics.html" class="nav-link">Forecasting &amp; Analytics</a>
      <a href="compliance.html" class="nav-link">Compliance &amp; Recall</a>
      <a href="suppliers.html" class="nav-link">Suppliers</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </nav>

    <footer class="sidebar-footer">v1.9</footer>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- TOP HEADER -->
    <header class="topbar">
      <div class="breadcrumbs"><span>Processing &amp; Yield</span></div>
    </header>

    <!-- CONTENT -->
    <section class="page show" id="processing">
      <div class="stack">

        <!-- Pushed Batches -->
        <div class="card split">
          <div class="card-head"><h2>Pushed Batches</h2></div>
          <div class="table-scroll">
            <table class="table" id="tbl-pushed-batches">
              <thead>
                <tr>
                  <th>Batch</th>
                  <th>Product Name</th>
                  <th>Quantity (kg)</th>
                  <th>Expire</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Product List -->
        <div class="card split">
          <div class="card-head"><h2>Product List</h2></div>
          <div class="table-scroll">
            <table class="table" id="tbl-product-list">
              <thead>
                <tr>
                  <th>Product ID</th>
                  <th>Product Package Name</th> <!-- NEW between Product ID and Batch -->
                  <th>Batch Code</th>
                  <th>Cut Type</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- FOOTER -->
    <footer class="footer">Â© 2025 MeatOps â€¢ All actions are auditable.</footer>
  </main>

  <!-- PACK MODAL -->
  <div class="modal" id="modal-pack" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Pack Batch</h3>
        <button class="icon close-modal">âœ•</button>
      </div>

      <form class="form" id="form-pack">
        <div class="two">
          <label>Batch Code
            <input id="pack_batch_code" readonly>
          </label>
          <label>Batch Product Name
            <input id="pack_product_name" readonly>
          </label>
        </div>

        <div class="two">
          <!-- Take product_id from product table (datalist) -->
          <label>Product Package ID (product.product_id)
            <input id="pack_package_pid" list="dlist-products" inputmode="numeric" placeholder="e.g., 1012" required>
            <datalist id="dlist-products"></datalist>
          </label>
          <label>Total Quantity (kg)
            <input id="pack_total_qty" readonly>
          </label>
        </div>

        <div class="two">
          <label>Package Size
            <select id="pack_size" required>
              <option value="1">1 kg</option>
              <option value="5">5 kg</option>
              <option value="10">10 kg</option>
            </select>
          </label>
          <div>
            <label>&nbsp;</label>
            <div id="pack_preview" class="muted"></div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" data-cancel>Cancel</button>
          <button class="btn primary" type="submit">Pack</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Hidden canvas used to render barcodes before embedding in PDF -->
  <canvas id="barcodeCanvas" width="640" height="160" style="display:none"></canvas>

  <!-- SCRIPTS -->
  <!-- Barcode + PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    /* ---------- helpers ---------- */
    async function fetchJSON(url, options={}) {
      const res = await fetch(url, options);
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { throw new Error('Server returned non-JSON. Preview: ' + text.slice(0, 300)); }
    }
    function fmt2(n){ return Number(n ?? 0).toFixed(2); }
    function daysLeft(expireStr){
      if(!expireStr) return '';
      const today = new Date(); today.setHours(0,0,0,0);
      const exp   = new Date(expireStr);
      const diff  = Math.round((exp - today) / (1000*60*60*24));
      if(diff < 0) return `${Math.abs(diff)}d ago (expired)`;
      if(diff === 0) return 'expires today';
      return `${diff}d left`;
    }

    /* ---------- modal control ---------- */
    function openModal(id){const m=document.getElementById(id);if(m){m.setAttribute('aria-hidden','false');document.body.classList.add('body-modal-open');}}
    function closeModal(el){const modal=typeof el==='string'?document.getElementById(el):el.closest('.modal');if(!modal)return;modal.setAttribute('aria-hidden','true');if(![...document.querySelectorAll('.modal')].some(x=>x.getAttribute('aria-hidden')==='false')){document.body.classList.remove('body-modal-open');}}
    document.addEventListener('click', e=>{
      if(e.target.matches('.close-modal,[data-cancel]')) closeModal(e.target);
      if(e.target.classList.contains('modal')) closeModal(e.target);
    });

    /* ---------- TABLE 1: Pushed Batches ---------- */
    const pushedTbody = document.querySelector('#tbl-pushed-batches tbody');

    function pushedRowHTML(r){
      return `
        <tr data-id="${r.id}" data-batch="${r.batch_code}">
          <td>${r.batch_code}</td>
          <td>${r.product}</td>
          <td>${fmt2(r.qty_kg)}</td>
          <td>${daysLeft(r.expire_date)}</td>
          <td><button class="btn sm primary act-pack">Pack</button></td>
        </tr>
      `;
    }

    async function loadPushedBatches(){
      pushedTbody.innerHTML = '<tr><td colspan="5">Loadingâ€¦</td></tr>';
      try{
        const j = await fetchJSON('api/batch-list.php');
        if(!j.ok) throw new Error(j.error || 'Load failed');
        const list = (Array.isArray(j.data) ? j.data : []).filter(r => Number(r.pushed) === 1);
        pushedTbody.innerHTML = list.length
          ? list.map(pushedRowHTML).join('')
          : '<tr><td colspan="5">No pushed batches yet.</td></tr>';
      }catch(err){
        pushedTbody.innerHTML = `<tr><td colspan="5">Failed to load.<div class="muted">${err.message}</div></td></tr>`;
      }
    }

    /* ---------- TABLE 2: Product List ---------- */
    const prodTbody = document.querySelector('#tbl-product-list tbody');

    function productRowHTML(p){
      return `
        <tr data-pid="${p.product_id}" data-weight="${fmt2(p.weight_kg ?? 0)}" data-pkgname="${p.product_package_name ?? ''}">
          <td>${p.product_id}</td>
          <td>${p.product_package_name ?? ''}</td>
          <td>${p.batch_code}</td>
          <td>${p.product_name}</td>
          <td>
            <button class="btn sm outline act-print">Print</button>
            <button class="btn sm danger act-delete">Delete</button>
          </td>
        </tr>
      `;
    }

    async function loadProducts(){
      prodTbody.innerHTML = '<tr><td colspan="5">Loadingâ€¦</td></tr>';
      try{
        const j = await fetchJSON('api/product-list-list.php');
        if(!j.ok) throw new Error(j.error || 'Load failed');
        const list = Array.isArray(j.data) ? j.data : [];
        prodTbody.innerHTML = list.length
          ? list.map(productRowHTML).join('')
          : '<tr><td colspan="5">No products yet.</td></tr>';
      }catch(err){
        prodTbody.innerHTML = `<tr><td colspan="5">Failed to load.<div class="muted">${err.message}</div></td></tr>`;
      }
    }

    /* ---------- Pack modal wiring ---------- */
    const packForm         = document.getElementById('form-pack');
    const fldPackBatchCode = document.getElementById('pack_batch_code');
    const fldPackProdName  = document.getElementById('pack_product_name');
    const fldPackTotalQty  = document.getElementById('pack_total_qty');
    const selPackSize      = document.getElementById('pack_size');
    const fldPkgPID        = document.getElementById('pack_package_pid');
    const packPreview      = document.getElementById('pack_preview');
    const dlistProducts    = document.getElementById('dlist-products');

    let productsLoaded = false;
    async function ensureProductsDatalist(){
      if (productsLoaded) return;
      try{
        const j = await fetchJSON('api/products-suggest.php'); // returns [{product_id, product_name}]
        if (j.ok && Array.isArray(j.data)) {
          dlistProducts.innerHTML = j.data
            .map(p => `<option value="${p.product_id}">${p.product_id} â€” ${p.product_name}</option>`)
            .join('');
          productsLoaded = true;
        }
      }catch(_){}
    }

    function updatePackPreview(){
      const total = parseFloat(fldPackTotalQty.value)||0;
      const size  = parseFloat(selPackSize.value)||0;
      if(!total || !size){ packPreview.textContent=''; return; }
      const whole = Math.floor(total/size);
      const rem   = +(total - (whole*size)).toFixed(2);
      const parts = whole + (rem>0?1:0);
      const detail = rem>0 ? `${whole}Ã—${size}kg + 1Ã—${rem}kg` : `${whole}Ã—${size}kg`;
      packPreview.textContent = `This will create ${parts} package(s): ${detail}.`;
    }
    selPackSize.addEventListener('change', updatePackPreview);

    pushedTbody.addEventListener('click', async e=>{
      const row = e.target.closest('tr'); if(!row) return;
      if(e.target.closest('.act-pack')){
        const c = row.children;
        fldPackBatchCode.value = c[0].textContent.trim();
        fldPackProdName.value  = c[1].textContent.trim();
        fldPackTotalQty.value  = c[2].textContent.trim();
        selPackSize.value = '1'; fldPkgPID.value = '';
        updatePackPreview();
        await ensureProductsDatalist(); // load choices before opening
        openModal('modal-pack');
      }
    });

    packForm.addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        const payload = {
          batch_code: fldPackBatchCode.value,
          batch_product_name: fldPackProdName.value,
          total_qty_kg: parseFloat(fldPackTotalQty.value)||0,
          size_kg: parseFloat(selPackSize.value)||0,
          product_package_id: parseInt(fldPkgPID.value,10)||0,
          replace_existing: 1
        };
        if (!payload.product_package_id) throw new Error('Please choose a valid Product Package ID from product table.');
        const j = await fetchJSON('api/product-list-pack.php', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!j.ok) throw new Error(j.error || 'Pack failed');
        await loadProducts();
        closeModal('modal-pack');
        packForm.reset();
      }catch(err){ alert(err.message); }
    });

    /* ---------- Delete / Print in Product List ---------- */
    function barcodeDataURL(value){
      if (!window.JsBarcode) throw new Error('Barcode library not loaded.');
      const canvas = document.getElementById('barcodeCanvas');
      JsBarcode(canvas, value, {
        format: 'CODE128',
        displayValue: false,
        margin: 0,
        height: 120,   // canvas pixels; scaled down in PDF
        width: 2
      });
      return canvas.toDataURL('image/png');
    }

    function printLabelPDF({pid, batch, pkgname, name, weight}){
      if (!window.jspdf || !window.jspdf.jsPDF) { alert('PDF library not loaded.'); return; }
      const { jsPDF } = window.jspdf;

      // 80x50 mm landscape label
      const pdf = new jsPDF({ orientation:'landscape', unit:'mm', format:[50,80] });

      // Brand / title
      pdf.setFont('helvetica','bold'); pdf.setFontSize(12);
      pdf.text('MeatOps', 4, 7);

      // Top text
      pdf.setFont('helvetica','normal'); pdf.setFontSize(9);
      pdf.text(`PID: ${pid}`, 4, 13);
      pdf.text(`Batch: ${batch}`, 40, 13);

      // Middle text
      const pkg = (pkgname || '').toString();
      const nm  = (name || '').toString();
      const trim = (s, max) => (s.length > max ? s.slice(0, max-1) + 'â€¦' : s);
      pdf.text(`Package: ${trim(pkg, 32)}`, 4, 18);
      pdf.text(`Type: ${trim(nm, 32)}`, 4, 23);

      pdf.text(`Weight: ${weight} kg`, 4, 28);
      const today = new Date();
      const ds = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      pdf.text(`Date: ${ds}`, 40, 28);

      // Barcode (product_id)
      try {
        const barData = barcodeDataURL(pid);
        // x, y, w, h
        pdf.addImage(barData, 'PNG', 4, 31, 72, 14);
      } catch(e) {
        pdf.setFont('helvetica','bold'); pdf.setTextColor(200,0,0);
        pdf.text('Barcode error', 4, 40);
        pdf.setTextColor(0,0,0);
      }

      pdf.save(`${pid}.pdf`);
    }

    prodTbody.addEventListener('click', async e=>{
      const row = e.target.closest('tr'); if(!row) return;

      if(e.target.closest('.act-delete')){
        const pid = row.dataset.pid;
        if(!confirm(`Delete ${pid}?`)) return;
        try{
          const j = await fetchJSON('api/product-list-delete.php', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ product_id: pid })
          });
          if(!j.ok) throw new Error(j.error || 'Delete failed');
          row.remove();
          if(!prodTbody.children.length){
            prodTbody.innerHTML = '<tr><td colspan="5">No products yet.</td></tr>';
          }
        }catch(err){ alert(err.message); }
      }

      if(e.target.closest('.act-print')){
        // Gather row data
        const pid     = row.dataset.pid;
        const weight  = row.dataset.weight;
        const pkgname = row.dataset.pkgname || '';
        const batch   = row.children[2].textContent.trim(); // 3rd column (Batch Code)
        const name    = row.children[3].textContent.trim(); // 4th column (Product Name)
        try{
          printLabelPDF({pid, batch, pkgname, name, weight});
        }catch(err){ alert(err.message); }
      }
    });

    /* ---------- init ---------- */
    loadPushedBatches();
    loadProducts();
  </script>

  <!-- Highlight current nav item -->
  <script>
    (function () {
      const here = (location.pathname.split('/').pop() || 'dashboard.html').toLowerCase();
      document.querySelectorAll('aside .nav a.nav-link').forEach(a => {
        const href = a.getAttribute('href') || '';
        const target = href.split('/').pop().split('#')[0].toLowerCase();
        if (here === target || (here === '' && target === 'dashboard.html')) {
          a.classList.add('active');
        }
      });
    }());
  </script>
</body>
</html>
