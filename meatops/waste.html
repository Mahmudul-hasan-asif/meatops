<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MeatOps Admin â€“ Waste Management</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Page-scoped: no global CSS changes */
    .page#waste .muted { color:#9aa4b2; font-size:.9rem; }
    .page#waste .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .page#waste .right { text-align:right; }
    .page#waste .actions-inline{ display:flex; gap:.5rem; align-items:center; justify-content:flex-end; }
    .page#waste .note{ margin:.5rem 0 0; }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-icon">ðŸ¥©</div>
      <div><h1>MeatOps</h1><small>Admin Console</small></div>
    </div>
    <nav class="nav">
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="intake.html" class="nav-link">Livestock / Intake</a>
      <a href="processing.html" class="nav-link">Processing &amp; Yield</a>
      <a href="inventory.html" class="nav-link">Inventory</a>
      <a href="storage.html" class="nav-link">Storage &amp; IoT</a>
      <a href="quality.html" class="nav-link">Quality Control</a>
      <a href="orders.html" class="nav-link">Orders &amp; Distribution</a>
      <a href="analytics.html" class="nav-link">Forecasting &amp; Analytics</a>
      <a href="compliance.html" class="nav-link">Compliance &amp; Recall</a>
      <a href="customer.html" class="nav-link">Customers</a>
      <a href="waste.html" class="nav-link active">Waste</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </nav>
    <footer class="sidebar-footer">v4.1</footer>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="topbar">
      <div class="breadcrumbs"><span>Waste Management</span></div>
    </header>

    <section class="page show" id="waste">
      <div class="stack">

        <!-- READ-ONLY WASTE TABLE -->
        <div class="card split">
          <div class="card-head">
            <h2>Waste (read-only)</h2>
          </div>

          <div id="wmsg" class="msg err" style="display:none"></div>

          <div class="table-scroll">
            <table class="table" id="tbl-waste">
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th>Product ID</th>
                  <th style="width:110px">Batch ID</th>
                  <th>Batch Code</th>
                  <th>Product Name</th>
                  <th class="right" style="width:130px">Weight (kg)</th>
                  <th class="right" style="width:160px">Package Size (kg)</th>
                  <th style="width:180px">Created</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="8">Loadingâ€¦</td></tr>
              </tbody>
            </table>
          </div>
          <p class="muted note">This table reflects the <span class="mono">waste</span> database table and is intentionally read-only.</p>
        </div>

        <!-- CAPTURE / LATEST (OPTIONAL ACTIONS) -->
        <div class="card split">
          <div class="card-head">
            <h2>Latest Waste Captures</h2>
            <button class="btn primary open-modal" data-modal="modal-add">+ Add Waste</button>
          </div>

          <div id="cmsg" class="msg err" style="display:none"></div>

          <div class="table-scroll">
            <table class="table" id="tbl-latest">
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th>Product ID</th>
                  <th>Batch Code</th>
                  <th>Product Name</th>
                  <th class="right" style="width:130px">Weight (kg)</th>
                  <th class="right" style="width:160px">Package Size (kg)</th>
                  <th style="width:180px">Created</th>
                  <th style="width:140px">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="8">Loadingâ€¦</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <footer class="footer">Â© 2025 MeatOps â€¢ All actions are auditable.</footer>
  </main>

  <!-- ADD WASTE MODAL -->
  <div class="modal" id="modal-add" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Add Waste</h3>
        <button class="icon close-modal" aria-label="Close">âœ•</button>
      </div>
      <form id="form-add" class="form" novalidate>
        <div class="two">
          <label>Product ID
            <input id="p_product_id" maxlength="40" placeholder="e.g., P-CHKN-001" required />
          </label>
          <label>Batch ID
            <input id="p_batch_id" type="number" placeholder="(optional)" />
          </label>
        </div>
        <div class="two">
          <label>Batch Code
            <input id="p_batch_code" maxlength="20" placeholder="e.g., B-240801-01" />
          </label>
          <label>Product Name
            <input id="p_product_name" maxlength="100" placeholder="Chicken Breast Boneless" required />
          </label>
        </div>
        <div class="two">
          <label>Weight (kg)
            <input id="p_weight" type="number" step="0.01" placeholder="e.g., 12.50" />
          </label>
          <label>Package Size (kg)
            <input id="p_pkg" type="number" step="0.01" placeholder="e.g., 1.00" />
          </label>
        </div>
        <div id="p_msg" class="msg err" style="display:none"></div>
        <div class="modal-actions">
          <button class="btn" type="button" data-cancel>Cancel</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ---------- modal helpers ---------- */
    function openModal(id){ const m=document.getElementById(id); if(m){ m.setAttribute('aria-hidden','false'); document.body.classList.add('body-modal-open'); } }
    function closeModal(el){
      const m = el.closest?.('.modal') || (typeof el==='string' ? document.getElementById(el) : null);
      if(!m) return; m.setAttribute('aria-hidden','true');
      const anyOpen = Array.from(document.querySelectorAll('.modal')).some(x=>x.getAttribute('aria-hidden')==='false');
      if(!anyOpen) document.body.classList.remove('body-modal-open');
    }
    document.addEventListener('click', e=>{
      if(e.target.matches('.open-modal')) openModal(e.target.dataset.modal);
      if(e.target.matches('.close-modal,[data-cancel]')) closeModal(e.target);
      if(e.target.classList.contains('modal')) closeModal(e.target);
    });

    /* ---------- endpoints (new) ---------- */
    const API = {
      list:   'api/waste-list.php',     // GET
      create: 'api/waste-create.php',   // POST
      del:    'api/waste-delete.php'    // DELETE (optional)
    };

    /* ---------- utils ---------- */
    const $ = s => document.querySelector(s);
    function showErr(id, text){ const el=document.getElementById(id); if(text){el.textContent=text; el.style.display='block'; } else { el.style.display='none'; } }
    async function fetchJSON(url, opts={}){ const r=await fetch(url,opts); const t=await r.text(); try{ return JSON.parse(t); }catch{ throw new Error('Server returned non-JSON: '+t.slice(0,260)); } }
    function fmt(t){ if(!t) return ''; try{ return new Date(t.replace(' ','T')).toLocaleString(); }catch{ return t; } }
    function num(x){ return x==null || x==='' ? '' : (+x).toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:2}); }

    /* ---------- loaders ---------- */
    async function loadWaste(){
      const tb = document.querySelector('#tbl-waste tbody');
      try{
        const j = await fetchJSON(API.list);
        if(!j.ok) throw new Error(j.error||'Load failed');
        const rows = j.data || [];
        if(!rows.length){ tb.innerHTML = '<tr><td colspan="8">No waste recorded.</td></tr>'; return; }
        tb.innerHTML = rows.map(r=>`
          <tr>
            <td>${r.id}</td>
            <td class="mono">${r.product_id||''}</td>
            <td>${r.batch_id??''}</td>
            <td class="mono">${r.batch_code||''}</td>
            <td>${r.product_name||''}</td>
            <td class="right">${num(r.weight_kg)}</td>
            <td class="right">${num(r.package_size_kg)}</td>
            <td>${fmt(r.created_at)}</td>
          </tr>`).join('');
      }catch(e){
        showErr('wmsg', e.message);
        tb.innerHTML = '<tr><td colspan="8">Error</td></tr>';
      }
    }

    async function loadLatest(){
      const tb = document.querySelector('#tbl-latest tbody');
      try{
        const j = await fetchJSON(API.list);
        if(!j.ok) throw new Error(j.error||'Load failed');
        const rows = (j.data||[]).slice(0,25); // latest 25 by endpoint order
        if(!rows.length){ tb.innerHTML = '<tr><td colspan="8">Empty</td></tr>'; return; }
        tb.innerHTML = rows.map(r=>`
          <tr>
            <td>${r.id}</td>
            <td class="mono">${r.product_id||''}</td>
            <td class="mono">${r.batch_code||''}</td>
            <td>${r.product_name||''}</td>
            <td class="right">${num(r.weight_kg)}</td>
            <td class="right">${num(r.package_size_kg)}</td>
            <td>${fmt(r.created_at)}</td>
            <td class="actions-inline">
              <button class="btn sm danger" data-del="${r.id}">Delete</button>
            </td>
          </tr>`).join('');

        tb.querySelectorAll('button[data-del]').forEach(btn=>{
          btn.onclick = async () => {
            if(!confirm('Delete this waste record?')) return;
            try{
              const j = await fetchJSON(`${API.del}?id=${encodeURIComponent(btn.dataset.del)}`, {method:'DELETE'});
              if(!j.ok) throw new Error(j.error||'Delete failed');
              await loadWaste(); await loadLatest();
            }catch(e){ alert(e.message); }
          };
        });
      }catch(e){
        showErr('cmsg', e.message);
        tb.innerHTML = '<tr><td colspan="8">Error</td></tr>';
      }
    }

    function loadAll(){ loadWaste(); loadLatest(); }

    /* ---------- add waste ---------- */
    document.getElementById('form-add').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const body = {
        product_id:       $('#p_product_id').value.trim(),
        batch_id:         $('#p_batch_id').value.trim() || null,
        batch_code:       $('#p_batch_code').value.trim() || null,
        product_name:     $('#p_product_name').value.trim(),
        weight_kg:        $('#p_weight').value.trim() || null,
        package_size_kg:  $('#p_pkg').value.trim() || null
      };
      if(!body.product_id || !body.product_name){ showErr('p_msg','Product ID and Product Name are required.'); return; }
      try{
        const j = await fetchJSON(API.create, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        if(!j.ok) throw new Error(j.error||'Save failed');
        closeModal('modal-add');
        ['p_product_id','p_batch_id','p_batch_code','p_product_name','p_weight','p_pkg'].forEach(id=>document.getElementById(id).value='');
        await loadAll();
      }catch(e){ showErr('p_msg', e.message); }
    });

    /* ---------- init ---------- */
    (function init(){
      loadAll();
      // set nav active
      const here=(location.pathname.split('/').pop()||'waste.html').toLowerCase();
      document.querySelectorAll('aside .nav a.nav-link').forEach(a=>{
        const target=(a.getAttribute('href')||'').split('/').pop().split('#')[0].toLowerCase();
        if(here===target) a.classList.add('active');
      });
    })();
  </script>
</body>
</html>
